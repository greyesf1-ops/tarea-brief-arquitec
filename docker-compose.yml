version: '3.8'

services:
  # Broker de MensajerÃ­a: Apache Kafka
  kafka:
    image: bitnami/kafka:latest
    container_name: kafka_broker
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - ALLOW_ANONYMOUS_LOGIN=yes

  # Servicio 1: ERP (Productor de eventos)
  erp-service:
    image: python:3.9-slim
    container_name: erp_producer
    depends_on:
      - kafka
    command: >
      sh -c "pip install kafka-python && 
             python -c 'from kafka import KafkaProducer; import time;
             p = KafkaProducer(bootstrap_servers=\"kafka:9092\");
             print(\"Iniciando ERP con Kafka...\");
             while True:
                 p.send(\"pedidos\", b\"ORDEN-100: Camiseta Retail\");
                 print(\"Evento enviado a Kafka: Nueva Orden de Compra\");
                 time.sleep(10)'"

  # Servicio 2: Inventario (Consumidor de eventos)
  inventory-service:
    image: python:3.9-slim
    container_name: inventory_consumer
    depends_on:
      - kafka
    command: >
      sh -c "pip install kafka-python && 
             python -c 'from kafka import KafkaConsumer;
             c = KafkaConsumer(\"pedidos\", bootstrap_servers=\"kafka:9092\");
             print(\"Inventario escuchando eventos de Kafka...\");
             for m in c:
                 print(f\"[NOTIFICACION KAFKA]: Procesando stock para: {m.value.decode()}\")'"
